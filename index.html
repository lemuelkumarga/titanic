<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Lemuel Kumarga" />


<title>Estimating Survival Rate of Titanic Passengers</title>

<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<link href="index_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="index_files/highlightjs-9.12.0/highlight.js"></script>
<script src="shared/js/rmd/popover.js"></script>
<script src="shared/js/html-widgets.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="shared/css/defaults.css" />
<link rel="stylesheet" href="../../shared/css/definitions.css" />
<link rel="stylesheet" href="../../shared/css/general.css" />
<link rel="stylesheet" href="shared/css/Rmd.css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>






<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Estimating Survival Rate of Titanic Passengers</h1>
<h4 class="author"><em><span class="meta">Lemuel Kumarga</span></em></h4>
<h4 class="date"><em><span class="meta">Feb 2018 (Revised on Oct 2018)</span></em></h4>

</div>


<section id="problem-description" class="level2">
<h2>Problem Description</h2>
<p>Set for its maiden voyage in 1912, RMS Titanic was then considered unsinkable due to its robust structure. After picking up passengers in Southampton, Cherbourg and Queenstown, the ship set sail towards New York. It was on their way there that Titanic met its calamitous fate, crashing into an Iceberg and rendering more than 50% of the passengers lost.</p>
<p>There were many question marks concerning the events leading to and during the disaster. One of which was who survived and why. Fortunately, details of all passengers, along with their survival status were recorded. By analyzing these records, we can potentially answer the question by:</p>
<ol type="1">
<li><span class="hl">Creating a prediction model to assess a passenger’s <a data-toggle="popover" title="Survival Likelihood" data-content="The passenger's probability of surviving">survival likelihood</a> (Who)</span>, and</li>
<li><span class="hl">Understanding the factors causing a passenger to live (Why)</span>.</li>
</ol>
<p>To skip the methodology and proceed directly to the summary of results, click <a href="#summary-of-results">here</a>.</p>
<p><span style="color:var(--font-color-50)">FYI: This problem was posed as an introductory challenge in <a href="https://www.kaggle.com/c/titanic" target="_blank">Kaggle</a>. The passengers are divided into two groups, one for training and the other for testing. The former contains both the passengers’ personal details and outcomes, while the latter only contains personal informaion. The aim of the project is to develop a robust model through the training set, and predict the survival of passengers in the testing set.</span></p>
</section>
<section id="preliminaries" class="level2">
<h2>Preliminaries</h2>
<p>First load the necessary packages for this exercise.</p>
<pre class="r"><code># Load default settings for R Markdown -- see file for more details
source(&quot;shared/defaults.R&quot;)
# Load some helper functions
source(&quot;shared/helper.R&quot;)

options(stringsAsFactors = FALSE)
load_or_install.packages(&quot;purrr&quot;,&quot;mgcv&quot;,&quot;DMwR&quot;)

data_dir &lt;- &quot;data/&quot;
output_dir &lt;- &quot;output/&quot;

si &lt;- sessionInfo()
base_pkg_str &lt;- paste0(&quot;Base Packages: &quot;,paste(si[[&quot;basePkgs&quot;]], collapse=&quot;, &quot;))
attached_pkg_str &lt;- paste0(&quot;Attached Packages: &quot;,paste(names(si[[&quot;otherPkgs&quot;]]), collapse=&quot;, &quot;))
cat(paste0(base_pkg_str,&quot;\n&quot;,attached_pkg_str))</code></pre>
<pre><code>## Base Packages: grid, stats, graphics, grDevices, utils, datasets, methods, base
## Attached Packages: DMwR, lattice, mgcv, nlme, purrr, tidyr, pander, ggplot2, rlang, dplyr, knitr</code></pre>
</section>
<section id="data-overview" class="level2">
<h2>Data Overview</h2>
<p>We kick off by exploring the data that was provided:</p>
<pre class="r"><code>training_set &lt;- read.csv(paste0(data_dir, &quot;train.csv&quot;))
test_set &lt;- read.csv(data_dir %|% &quot;test.csv&quot;)

cols_summary &lt;- data_overview(training_set)

pander(cols_summary, caption=&#39;Titanic Passengers Data - For more info, please visit &lt;a href=&quot;https://www.kaggle.com/c/titanic/data&quot; target=&quot;_blank&quot;&gt;Kaggle&lt;/a&gt;&#39;)</code></pre>
<div class="table-responsive"><table style="width:96%;">
<caption>Titanic Passengers Data - For more info, please visit <a href="https://www.kaggle.com/c/titanic/data" target="_blank">Kaggle</a> <br></caption>
<colgroup>
<col style="width: 19%" />
<col style="width: 16%" />
<col style="width: 44%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">ColumnNames</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Examples</th>
<th style="text-align: left;">PctFilled</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PassengerId</td>
<td style="text-align: left;">INTEGER</td>
<td style="text-align: left;">1 // 2 // 3 // 4 // 5</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Survived</td>
<td style="text-align: left;">INTEGER</td>
<td style="text-align: left;">0 // 1</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pclass</td>
<td style="text-align: left;">INTEGER</td>
<td style="text-align: left;">3 // 1 // 2</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">CHARACTER</td>
<td style="text-align: left;">Braund, Mr. Owen Harris // Cumings, Mrs. John Bradley (Florence Briggs Thayer) // Heikkinen, Miss. Laina // Futrelle, Mrs. Jacques Heath (Lily May Peel) // Allen, Mr. William Henry</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sex</td>
<td style="text-align: left;">CHARACTER</td>
<td style="text-align: left;">male // female</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age</td>
<td style="text-align: left;">NUMERIC</td>
<td style="text-align: left;">22 // 38 // 26 // 35 // 54</td>
<td style="text-align: left;">80%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SibSp</td>
<td style="text-align: left;">INTEGER</td>
<td style="text-align: left;">1 // 0 // 3 // 4 // 2</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Parch</td>
<td style="text-align: left;">INTEGER</td>
<td style="text-align: left;">0 // 1 // 2 // 5 // 3</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ticket</td>
<td style="text-align: left;">CHARACTER</td>
<td style="text-align: left;">A/5 21171 // PC 17599 // STON/O2. 3101282 // 113803 // 373450</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fare</td>
<td style="text-align: left;">NUMERIC</td>
<td style="text-align: left;">7.25 // 71.2833 // 7.925 // 53.1 // 8.05</td>
<td style="text-align: left;">100%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Cabin</td>
<td style="text-align: left;">CHARACTER</td>
<td style="text-align: left;">C85 // C123 // E46 // G6 // C103</td>
<td style="text-align: left;">22%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Embarked</td>
<td style="text-align: left;">CHARACTER</td>
<td style="text-align: left;">S // C // Q</td>
<td style="text-align: left;">99%</td>
</tr>
</tbody>
</table></div>
<p>Based on the above table, we know that:</p>
<ul>
<li><span class="hl color-1-text">Names</span> are aggregated in the following format: <span class="hl color-2-text">Last_Name, Title First_Name</span>. This suggests that some information needs to be extracted from certain columns.</li>
<li>Columns such as <span class="hl color-1-text">Age</span> and <span class="hl color-1-text">Cabin</span> have missing data. This implies that we should either remove these columns, impute the data or build a model that handles missing information.</li>
</ul>
</section>
<section id="feature-selection" class="level2">
<h2>Feature Selection</h2>
<p>The first step in creating a prediction model is to brainstorm possible factors, otherwise known as <span class="hl">features</span>, influencing survival likelihood.</p>
<p>Some features have been nicely provided by the dataset, such as:</p>
<div class="table-responsive"><table>
<thead>
<tr class="header">
<th>Feature</th>
<th>Variable Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Pclass</td>
<td>Continuous</td>
<td>Ticket Class</td>
</tr>
<tr class="even">
<td>Sex</td>
<td>Categorical</td>
<td>Gender</td>
</tr>
<tr class="odd">
<td>Age</td>
<td>Continuous</td>
<td>Passenger’s Age</td>
</tr>
<tr class="even">
<td>SibSp</td>
<td>Continuous</td>
<td>Number of Siblings on Board</td>
</tr>
<tr class="odd">
<td>Parch</td>
<td>Continuous</td>
<td>Number of Parents/Children on Board</td>
</tr>
<tr class="even">
<td>Fare</td>
<td>Continuous</td>
<td>Ticket Fare</td>
</tr>
<tr class="odd">
<td>Embarked</td>
<td>Categorical</td>
<td>Place of Embarkation</td>
</tr>
</tbody>
</table></div>
<p>In addition to these base factors, we could also extract <span class="hl">derived features</span> which are further described below.</p>
<section id="titles" class="level4">
<h4>Titles</h4>
<p>The <span class="hl">Title</span> of an individual is typically associated with his/her social status. We should expect those with higher titles to be given preference to lifeboats, and hence having higher survival likelihoods.</p>
<pre class="r"><code>prefix &lt;- function(l) { as.character(sapply(l, ..(x) %:=% { unlist(strsplit(unlist(strsplit(x, &quot;, &quot;))[2],&quot;\\. &quot;))[1] })) }

title_set &lt;- training_set %&gt;%
             mutate(Title = prefix(Name))

# Find Titles that Have Sufficient Sample Size For Model Estimation (&gt;10)
common_titles &lt;- title_set %&gt;%
                 group_by(Title) %&gt;%
                 summarise(N=n()) %&gt;%
                 filter(N &gt; 10) %&gt;%
                 select(Title) %&gt;%
                 { c(.$Title) }

title_plot &lt;- training_set %&gt;%
              mutate(Title = ifelse(prefix(Name) %in% common_titles, prefix(Name), &quot;Rare Title&quot;)) %&gt;%
              mutate(MaleSurvivalRate = sum(Sex == &quot;male&quot; &amp; Survived == 1) / sum(Sex == &quot;male&quot;),
                     FemaleSurvivalRate = sum(Sex == &quot;female&quot; &amp; Survived == 1) / sum(Sex == &quot;female&quot;),
                     MixedSurvivalRate = sum(Survived) / n()) %&gt;%
              group_by(Title) %&gt;%
              summarise(CohortSize = n(),
                        SurvivalRate = sum(Survived)/n(),
                        Gender = sum(Sex == &quot;male&quot;)/n(),
                        MaleSurvivalRate = MaleSurvivalRate %&gt;% max,
                        FemaleSurvivalRate = FemaleSurvivalRate %&gt;% max,
                        MixedSurvivalRate = MixedSurvivalRate %&gt;% max) %&gt;%
              mutate(Gender = ifelse(Gender == 0, &quot;Female&quot;,
                                     ifelse(Gender == 1, &quot;Male&quot;, &quot;Mixed&quot;)),
                     BaselineRate = recode(Gender, Female=FemaleSurvivalRate, Male=MaleSurvivalRate, Mixed=MixedSurvivalRate)) %&gt;%
              arrange(Gender, desc(SurvivalRate)) %&gt;%
              mutate(Title = factor(Title, levels=Title %&gt;% unique)) %&gt;%
              {
                  ggplot(.,aes(x=Title, y=BaselineRate, fill=Gender)) +
                  theme_lk() +
                  geom_bar(stat=&quot;identity&quot;, 
                           alpha = 0.2,
                           width = .5, 
                           position=position_nudge(x=-0.25)) +                                       
                  geom_tile(aes(y=(BaselineRate + (SurvivalRate - BaselineRate) / 2.), 
                                height=SurvivalRate-BaselineRate), 
                            width = .5, 
                            fill = (.$SurvivalRate - .$BaselineRate &gt;= 0) %?% `@c`(green) %:% `@c`(red),
                            position = position_nudge(x=+0.2)) + 
                  geom_text(data=subset(.,SurvivalRate - BaselineRate &gt;= 0),
                            aes(label = &quot;+&quot; %|% scales::percent(SurvivalRate - BaselineRate),
                                y = SurvivalRate + 0.02),
                            nudge_x = 0.2,
                            family = `@f`,
                            color = `@c`(green)) +
                  geom_text(data=subset(.,SurvivalRate - BaselineRate &lt; 0),
                            aes(label = scales::percent(SurvivalRate - BaselineRate),
                                y = SurvivalRate - 0.02),
                            nudge_x = 0.2,
                            family = `@f`,
                            color = `@c`(red)) +
                  scale_fill_manual(name = &quot;Baseline Survival Rate&quot;,
                                    values = c(&quot;Male&quot;= `@c`(blue),
                                               &quot;Female&quot; =`@c`(red),
                                               &quot;Mixed&quot; = `@c`(purple))) +
                  scale_y_continuous(name=&quot;Survival Likelihood&quot;, 
                                     labels=scales::percent,
                                     expand=c(0,0,0.02,0))
              }

feature_title &lt;- function(Name) { ifelse(prefix(Name) %in% common_titles, 
                                         ifelse(prefix(Name) %in% c(&quot;Mr&quot;,&quot;Miss&quot;),&quot;Mr/Miss&quot;,prefix(Name)), &quot;Rare Title&quot;) }

title_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The chart above confirms our suspicion, as those with more distinguished status, such as <span class="hl color-2-text">Master</span> and <span class="hl color-2-text">Rare Title</span>, are more likely to survive.</p>
</section>
<section id="family-size" class="level4">
<h4>Family Size</h4>
<p>The <span class="hl">FamSize</span> of an individual is the amount of family members on board (including the passenger). It is an <a data-toggle="popover" title="Interaction Term" data-content="A feature that is a derivation from other features.">interaction term</a> from <span class="hl">SibSp</span> and <span class="hl">Parch</span>, and defined as <span class="math inline">\(FamSize = 1 + SibSp + Parch\)</span>. Assuming that everyone in the family has to stay together, we should expect those with larger family sizes to have higher likelihoods of dying.</p>
<pre class="r"><code>feature_famsize &lt;- function(Sibsp, Parch) { pmap(list(x=Sibsp, y=Parch), ..(x,y) %:=%  { x + y + 1 }) %&gt;% as.integer }

famsize_plot &lt;- training_set %&gt;%
                mutate(FamSize = feature_famsize(SibSp, Parch)) %&gt;%
                {
                  ggplot(., aes(x=FamSize, fill=factor(Survived))) +
                    theme_lk() +
                    theme(
                      axis.ticks.y = element_blank(),
                      axis.text.y = element_blank()
                    ) +
                    geom_density(color=NA, alpha=0.5, bw=&quot;bcv&quot;) +
                    scale_x_continuous(name=&quot;Family Size&quot;, expand=c(0,0), breaks=1:5*2) + 
                    scale_y_continuous(name=&quot;Density&quot;, expand=c(0,0,0.02,0)) +
                    scale_fill_manual(name=&quot;Cohort Size&quot;, values=c(`1`=`@c`(1),`0`=`@c`(ltxt)),
                                                          labels=c(`1`=&quot;Survived&quot;,`0`=&quot;Died&quot;))
                }

famsize_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Interestingly, we notice that those with intermediate family sizes are more likely to survive. This could be due to the presence of children. In other words, if you have a child, you are more likely to be given a space in the lifeboat, as opposed to those who are by themselves.</p>
</section>
<section id="cabin-deck" class="level4">
<h4>Cabin Deck</h4>
<p>The <span class="hl">CabinDeck</span> refers to the floor where an individual is staying. Based on <a target="_blank" href="https://www.dummies.com/education/history/titanic-facts-the-layout-of-the-ship/"> external sources</a>, Deck A corresponds to the highest floor (Promenade), while Deck G the lowest floor (Engine Room). Assuming that everyone was at his/her room during the time of crash, we should expect those nearest to the bridge to have an advantage in boarding the lifeboats.</p>
<pre class="r"><code>deck_to_index &lt;- c(&quot;A&quot;=1,&quot;B&quot;=2,&quot;C&quot;=3,&quot;D&quot;=4,&quot;E&quot;=5,&quot;F&quot;=6,&quot;G&quot;=7)

feature_cabin_deck &lt;- function(Cabin) {
  
  lapply(Cabin, ..(c) %:=% {
    
    # Get All Cabins Specified
    decks &lt;- strsplit(c %&gt;% { gsub(&quot;[0-9]&quot;,&quot;&quot;,.) },&quot; &quot;) %&gt;% unlist %&gt;%
            # Convert Cabins to Numeric
            sapply(..(f) %:=% {
              deck_to_index[f]
            })
    
    # Assume a Leave No Man Behind Approach,
    # In other words, your chances of survival is dependent on
    # the person with the worst deck in the group
    (length(decks) == 0) %?% NA %:% (decks %&gt;% as.integer %&gt;% max)
                
  }) %&gt;% unlist
}

cabin_deck_plot &lt;- training_set %&gt;%
                    mutate(CabinDeck = feature_cabin_deck(Cabin)) %&gt;%
                   filter(!is.na(CabinDeck)) %&gt;%
                  {
                    ggplot(., aes(x=CabinDeck, fill=factor(Survived))) +
                      theme_lk() +
                      theme(
                        axis.ticks.y = element_blank(),
                        axis.text.y = element_blank()
                      ) +
                      geom_density(color=NA, alpha=0.5, bw=&quot;bcv&quot;) +
                      scale_x_continuous(name=&quot;Cabin Deck&quot;, expand=c(0,0), breaks=deck_to_index, labels=setNames(names(deck_to_index),deck_to_index)) + 
                      scale_y_continuous(name=&quot;Density&quot;, expand=c(0,0,0.02,0)) +
                      scale_fill_manual(name=&quot;Cohort Size&quot;, values=c(`1`=`@c`(1),`0`=`@c`(ltxt)),
                                        labels=c(`1`=&quot;Survived&quot;,`0`=&quot;Died&quot;))
                  }

cabin_deck_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As expected, those in Cabin B to F have higher chances of surviving than those in the highest and lowest floors.</p>
</section>
<section id="cabin-number" class="level4">
<h4>Cabin Number</h4>
<p>The <span class="hl">CabinNo</span> of an individual corresponds to the side that an individual stays in (left/right of the boat). According to <a href="https://www.encyclopedia-titanica.org/titanic-deckplans/b-deck.html" target="_blank">Encyclopedia Titanica</a>, even numbers are situated on the left side, while odd numbers are on the right side. Depending on where the damage was, passengers staying on the unaffected side may be more likely to stay alive during the impact.</p>
<pre class="r"><code>feature_cabin_no &lt;- function(Cabin) {
  
  sapply(Cabin, ..(x) %:=% {
    if (x == &quot;&quot;) { return(NA) }
    
    num &lt;- as.integer(strsplit(gsub(&quot;[A-z]&quot;,&quot;&quot;,x),&quot; &quot;)[[1]]) %% 2
    
    if (is.nan(mean(num)) | length(which(num==0)) == length(which(num==1))) {
      return(NA)
    } else {
      # Check if there is more even cabins or odd cabins
      if (length(which(num==0)) &gt;= length(which(num==1))) { return(&quot;Even&quot;) } else { return(&quot;Odd&quot;) }
    }
  })
}

cabin_number_plot &lt;- training_set %&gt;%
                      mutate(CabinNo = feature_cabin_no(Cabin),
                             CabinNo = ifelse(is.na(CabinNo),&quot;Unspecified&quot;,CabinNo)) %&gt;%
                      group_by(CabinNo) %&gt;%
                      summarise(CohortSize = n(),
                                SurvivalRate = sum(Survived)/n()) %&gt;%
                      mutate(CabinNo = factor(CabinNo, levels=c(&quot;Even&quot;,&quot;Odd&quot;,&quot;Unspecified&quot;))) %&gt;%
                      {
                        ggplot(., aes(x = SurvivalRate,y = 0,color=CabinNo,size=CohortSize)) +
                          theme_lk() +
                          theme(plot.margin = unit(c(0,0,0,-40),&#39;pt&#39;),
                                legend.position = c(1.,0.05),
                                legend.box.just = c(0.5,0.5),
                                axis.line.x = element_line(colour=NA),
                                axis.ticks.x = element_line(colour=NA),
                                axis.title.x = element_blank(),
                                axis.text.x = element_blank(),
                                axis.line.y = element_line(colour=NA),
                                axis.ticks.y = element_line(colour=NA),
                                axis.title.y = element_blank(),
                                axis.text.y = element_blank()
                          ) +
                          scale_color_manual(name = &quot;Room Type&quot;,
                                             values = `@c`(),
                                             guide = guide_legend(order = 1,override.aes=list(size=5),
                                                                  nrow= 1)) +
                          scale_size_continuous(name = &quot;Cohort Size&quot;,
                                                range = c(5,20),breaks=c(100,300,600),
                                                guide = guide_legend(order = 2,override.aes=list(alpha=0.5), nrow=1)) +
                          # Add X Axis Line
                          geom_segment(data = data.frame(1),aes(x=0.25, xend=0.8, y=0, yend=0),
                                       size = 0.5,color=alpha(`@c`(ltxt),0.5),
                                       arrow = arrow(length = unit(10,&quot;pt&quot;),type = &quot;closed&quot;)) +
                          geom_text(data = data.frame(1),label = &quot;Survival Likelihood&quot;,
                                    x = 0.8,y = 0.02,family = `@f`,color = `@c`(ltxt),
                                    size = 4.5,hjust = 1) +
                          scale_y_continuous(limits=c(-0.12, 0.05)) +
                          geom_point() +
                          geom_text(aes(y = c(-0.025,-0.02,-0.04), label=paste0(round(SurvivalRate*100,0),&quot;%&quot;)),
                                    size=4,color=`@c`(txt),family=`@f`)
                      }

cabin_number_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>From the chart, it seems that those on the right side are more likely to survive, confirming our previous hypothesis.</p>
</section>
<section id="feature-summary" class="level3">
<h3>Feature Summary</h3>
<p>To summarise, all of the features, along with their relationship to survival status, are shown below. Based on observation, it seems that both <span class="hl">Sex</span> and <span class="hl">Pclass</span> will play dominant roles in estimating survival likelihood.</p>
<section id="continuous-features" class="level4">
<h4>Continuous Features</h4>
<pre class="r"><code>preprocess_data &lt;- function(data) {
  
  passengerIds &lt;-data$PassengerId
  data &lt;- data %&gt;%
          mutate(Title=feature_title(Name),
                 FamSize=feature_famsize(SibSp, Parch),
                 CabinDeck=feature_cabin_deck(Cabin),
                 CabinNo=feature_cabin_no(Cabin)) %&gt;%
          select(-Name, -Ticket, -Cabin) %&gt;%
          # Substitute unknown continuous features with -1
          mutate_if(is.numeric, 
                    ~ map(., ~ if (is.na(.)) { -1 } else {.}) %&gt;% unlist) %&gt;%
          # Substitute unknown discrete features with &quot;-&quot;
          mutate_if(~ !is.numeric(.),
                    ~ map(., ~ if (is.na(.) | . == &quot;&quot;) { &quot;-&quot;} else {.}) %&gt;% unlist) %&gt;%
          # Set Factors for Discrete Features
          mutate_if(~ !is.numeric(.),
                    ~ factor(., levels=unique(c(&quot;-&quot;,.))))
  rownames(data) &lt;- passengerIds
  data
}

features &lt;- preprocess_data(training_set)
test_features &lt;- preprocess_data(test_set)


suppressMessages({
  snapshot &lt;- data_snapshot(features %&gt;% select(-PassengerId) %&gt;% mutate(Survived = Survived %&gt;% factor), Survived,
                            cont_geom = geom_density(color=NA, alpha=0.5, bw=&quot;bcv&quot;),
                            misc_layers = scale_fill_manual(name = &quot;Status&quot;,
                                                            values=c(`0`=`@c`(ltxt,0.5),`1`=`@c`(1)),
                                                            labels=c(`0`=&quot;Died&quot;,`1`=&quot;Survived&quot;)))
})
plot(snapshot$cont_plot)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
</section>
<section id="categorical-features" class="level4">
<h4>Categorical Features</h4>
<pre class="r"><code>plot(snapshot$disc_plot)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
</section>
</section>
</section>
<section id="modeling-survival-likelihood" class="level2">
<h2>Modeling Survival Likelihood</h2>
<section id="model-selection" class="level3">
<h3>Model Selection</h3>
<p>After finalizing our list of features, we now have to choose the most appropriate model for this analysis. Based on our objectives, the model must be:</p>
<ol type="1">
<li><span class="hl">Predictive</span>: The model should predict survival likelihood accurately. This criteria excludes more simple models, such as Linear Regression, which is known to have high biases.</li>
<li><span class="hl">Interpretable</span>: The model should explain the relationships between features and survival status. This prevents us from selecting less interpretable models such as Random Forests, Gradient Boosting Trees or SVMs.</li>
<li><span class="hl">Robust</span>: The model should manage missing values effectively.</li>
</ol>
<p>Due to these criterias, the <a target="_blank" href="https://en.wikipedia.org/wiki/Generalized_additive_model">Generalized Additive Model (GAM)</a> will be used as our base. In particular, a GAM has the form:</p>
<p><span class="math display">\[Y = \ln(\frac{p}{1-p}) = \beta_0 + \sum_i f_i(x_i) \]</span></p>
<p>where <br> <span class="math inline">\(p\)</span> is the survival likelihood, <br> <span class="math inline">\(\beta_0\)</span> is the average of <span class="math inline">\(Y\)</span>, <br> <span class="math inline">\(f_i\)</span> is a smooth function of the feature <span class="math inline">\(i\)</span>, and <br> <span class="math inline">\(x_i\)</span> is the value of feature <span class="math inline">\(i\)</span>.</p>
<p>In addition, we will also be making the following adjustments to the GAM model:</p>
<ol type="1">
<li><span class="hl">Missing Values</span>: All <span class="math inline">\(f_i(\)</span>Missing<span class="math inline">\()\)</span> will have a value of <span class="math inline">\(0\)</span>. This ensures that missing factors will not influence a passenger’s survival prediction.</li>
<li><a target="_blank" href="https://www.stat.ubc.ca/~rollin/teach/643w04/lec/node41.html"><span class="hl">Forward Selection</span></a>: Earlier on, we have chosen over 10 features for the model, some of which may be irrelevant. To exclude such features, we will fit each predictor into the model iteratively. At the end, the number of features to be used for prediction will be determined via <a data-toggle="popover" title="Cross Validation" data-content="Cross validation is a process where the data is split into N parts. (N - 1) parts are used to generate the model, and the last one is used to test the model. This is done for a total of N times, so that each part will be a test set once. The prediction error from the test set is known as the CV Error Rate.">cross validation</a>.</li>
</ol>
</section>
<section id="embedding-survival-relationships" class="level3">
<h3>Embedding Survival Relationships</h3>
<p>One of the major issues with GAM is the failure to encode relationships amongst passengers. For instance, a mother’s survival status could highly depend on the child’s. To account for these factors, we introduce two hidden features in the model:</p>
<ul>
<li><span class="hl">PfemaleM</span>: The probability that a passenger’s female family member will survive, and</li>
<li><span class="hl">PmaleM</span>: The probability that a passenger’s male family member will survive.</li>
</ul>
<p>To estimate the two features, we first need the survival likelihood of every individual. Each individual’s family can then be identified through his/her <span class="hl">last name</span>, <span class="hl">passenger class</span> and <span class="hl">port of embarkation</span>. The survival likelihoods of family members are then averaged across <span class="hl">Sex</span> to obtain <span class="hl">PfemaleM</span> and <span class="hl">PmaleM</span> respectively.</p>
<pre class="r"><code>lastName &lt;- function(l) { as.character(sapply(l, ..(x) %:=% { (unlist(strsplit(x, &quot;, &quot;))[[1]]) })) }

complete_dataset &lt;- rbind(features %&gt;% select(-Survived), test_features)

feature_fam_survivalhood &lt;- function(p_survival) {
  
  # Calculate each family member&#39;s probability of survival
  indiv_survivalhood &lt;- complete_dataset %&gt;% 
    cbind(FamID=c(training_set$Name,test_set$Name) %&gt;% lastName) %&gt;%
    mutate(FamID= FamID %|% &quot;_&quot; %|% Pclass %|% &quot;_&quot; %|% Embarked) %&gt;%
    mutate(PSurvival = p_survival) %&gt;% 
    select(PassengerId, Sex, FamID, PSurvival)
  
  # Find the probability of the passenger&#39;s family members surviving (excluding the passenger him/herself),
  # separated by gender
  updated_dataset &lt;- indiv_survivalhood %&gt;%
    select(PassengerIdBase=PassengerId, FamID) %&gt;%
    inner_join(indiv_survivalhood, by=&quot;FamID&quot;) %&gt;%
    mutate(FamPSurvived = ifelse(PassengerId == PassengerIdBase, NA, PSurvival)) %&gt;%
    select(PassengerId = PassengerIdBase, Sex, FamPSurvived) %&gt;%
    group_by(PassengerId, Sex) %&gt;%
    summarise(FamPSurvived = mean(FamPSurvived, na.rm =TRUE)) %&gt;%
    ungroup() %&gt;%
    mutate(Sex = &quot;P&quot; %|% Sex %|% &quot;F&quot;) %&gt;%
    spread(key=&quot;Sex&quot;, value=&quot;FamPSurvived&quot;)
  
  updated_dataset[is.na(updated_dataset)] &lt;- -1
  
  updated_dataset
}</code></pre>
<p>Assuming the existence of survival likelihoods, the GAM model can be generated with the formula:</p>
<p><span class="math display">\[Y = \ln(\frac{p}{1-p}) = \beta_0 + \sum_i f_i(x_i) + f_f(p_{fem}) + f_m(p_{male}) \]</span></p>
<p>where <br> <span class="math inline">\(p_{fem}\)</span> is the survival likelihood of a female family member, <br> <span class="math inline">\(p_{male}\)</span> is the survival likelihood of a male family member, <br> and <span class="math inline">\(f_f, f_m\)</span> are the smooth functions for both.</p>
<p>The biggest challenge in generating this model is <span class="hl">recursion</span>. The hidden features require survival likelihoods from the model, which in turn requires the hidden features. Fortunately, we can break this chain by assuming that the existence of an equilibrium <span class="math inline">\(\hat{p}\)</span> where:</p>
<p><span class="math display">\[ \ln(\frac{\hat{p}}{1-\hat{p}}) =  Y - \beta_0 - \sum_i f_i(x_i) = f_f(p_{fem}(\hat{p})) + f_m(p_{male}(\hat{p})) \]</span></p>
<p>Assuming convergence, <span class="math inline">\(\hat{p}\)</span> can be determined via the following algorithm: <code style="background-color:var(--pri)"> <br> Initialize: <br> DATA := (x_1, x_2, …, x_k) <br> MODEL := GAM(DATA) <br> PREV_P := PREDICT(MODEL) <br> <br> # Use 10 Iterations for Convergence<br> for i in [1,10]:<br>   (p_female, p_male) &lt;- GET_HIDDEN_FEATURE(PREV_P)<br>   DATA &lt;- (x_1, x_2, … , x_k, p_female, p_male)<br>   MODEL &lt;- GAM(DATA)<br>   P &lt;- PREDICT(MODEL)<br>   if (SUM{(P - PREV_P)^2} &lt; 0.0001) BREAK<br>   else PREV_P &lt;- P<br> RETURN MODEL </code></p>
</section>
<section id="model-implementation" class="level3">
<h3>Model Implementation</h3>
<p>The Adjusted GAM is implemented using the code below.</p>
<pre class="r"><code>predict.mod_gam &lt;- function(object, newdata, type=&quot;link&quot;, threshold=0.5, ...) {
  
  # There is a Bug in GAM where if we use &quot;by&quot;, predict will crash with the following error message:
  # newdata is a model.frame: it should contain all required variables
  # This is an attempt to fix that
  gp &lt;- interpret.gam(object$formula)
  # if new data has no Survived column, append to fix the bug
  if (!(&quot;Survived&quot; %in% colnames(newdata))) {
    newdata[,&quot;Survived&quot;] &lt;- rep(-999,nrow(newdata))
  }
  
  # Append recursive features of the model
  if (!is.null(object$rec_features)) {
    newdata &lt;- newdata %&gt;%
               inner_join(object$RecFeatureData %&gt;% select(c(&quot;PassengerId&quot;,object$rec_features)), by=&quot;PassengerId&quot;)
  }
  
  newdata &lt;- model.frame(gp$fake.formula, newdata)
  if (type == &quot;class&quot;) {
    (predict.gam(object=object, newdata=newdata, type=&quot;response&quot;, ...) &gt;= threshold) * 1
  } else {
    predict.gam(object=object, newdata=newdata, type=type, ...)
  }
}

mod.gam &lt;- function(data) {
  
  all_features &lt;- data %&gt;% select(-Survived, -PassengerId)
  disc_vars &lt;- all_features %&gt;% select_if(~ !is.numeric(.)) %&gt;% colnames
  
  # 1. Handling Missing Values: We specify a by constraint for each smoothing spline to ensure that
  # f(NA) = 0
  cont_to_spline &lt;- function(v, dt = data) {
    map(v, ~ &quot;s(&quot; %|% . %|% 
          &quot;, k=&quot; %|% { (length(unique(dt[,.])) &gt;= 10) %?% -1 %:% length(unique(dt[,.]) %&gt;% {.[. != -1]}) } %|% 
          &quot; ,by=(&quot; %|% . %|%  &quot; &gt;= 0)*1)&quot;) %&gt;% unlist
  }
  cont_vars &lt;- all_features %&gt;% select_if(is.numeric) %&gt;% colnames %&gt;% cont_to_spline(dt = data)
    

  
  # Helper Function to Build Modified GAM Model
  build_gam(vars, dt=data) %:=% {
    all_vars &lt;- vars %&gt;% paste0(collapse=&quot; + &quot;)
    m.gam &lt;- gam(&quot;Survived ~ &quot; %|% all_vars %&gt;% as.formula, data=dt, family=&quot;binomial&quot;)
    class(m.gam) &lt;- c(&quot;mod_gam&quot;,class(m.gam))
    if (max(summary(m.gam)$p.table[,2]) &gt;= 10) { warning(&quot;High Standard Errors.&quot;) } 
    m.gam
  }  
  
  # 2. Perform Forward Selection: Chi square statistic is the measure chosen
  cur_vars &lt;- c()
  rem_vars &lt;- c(cont_vars,disc_vars)
  last.gam &lt;- build_gam(c(&quot;1&quot;))
  for (i in 1:length(rem_vars)) {
    # We attempt to find out which variables to put in next.
    # There are three extreme cases where we want to prevent the particular
    # var from being inserted
    # 1. If GAM calibration returns an error
    # 2. If GAM calibration returns a warning (often no convergence)
    # 3. If GAM calibration results in high standard errors
    chi_sq &lt;- sapply(rem_vars, ..(v) %:=% {
      tryCatch({ 
        m.gam &lt;- build_gam(c(cur_vars,v)); 
        (last.gam$deviance - m.gam$deviance) / ((m.gam$edf %&gt;% sum) - (last.gam$edf %&gt;% sum)) }, 
        warning= ..(e) %:=% { return(-Inf) },
        error= ..(e) %:=% { return(-Inf) })
      })
    
    # If all of the remaining vars cause errors, terminate forward selection
    if (max(chi_sq) == -Inf) { break }
    
    best.var &lt;- chi_sq %&gt;% which.max %&gt;% names
    cur_vars &lt;- c(cur_vars, best.var)
    rem_vars &lt;- rem_vars[rem_vars != best.var]
    last.gam &lt;- suppressWarnings(build_gam(cur_vars))
  }  
  
  
  lapply(1:length(c(cont_vars, disc_vars)), ..(i) %:=% {
    if (i &gt; length(cur_vars)) { return(NULL) }
    
    # 3. Recursive Fitting: Use Other Family Member&#39;s Probabilities to sharpen the estimation
    # of the passenger&#39;s probability
    base_training &lt;- data
    base_model &lt;- build_gam(cur_vars[1:i])
    last_p &lt;- predict(base_model, complete_dataset, type=&quot;response&quot;)

    tryCatch({
      cat(&quot;Starting Recursive Feature Fitting for &quot; %|% i %|% &quot;-Feature...\n&quot;)
      for (it in 1:10) {
        
        # Get the Feature for all the dataset
        fam_survivalhood &lt;- feature_fam_survivalhood(last_p)
        rec_features &lt;- colnames(fam_survivalhood %&gt;% select(-PassengerId)) 
        
        # Reset the Feature to the latest one
        if (any(rec_features %in% colnames(base_training))) { 
          base_training &lt;- base_training %&gt;% select_(.dots=&quot;-&quot; %|% rec_features)
        }
        base_training &lt;- base_training %&gt;% inner_join(fam_survivalhood, by=&quot;PassengerId&quot;)
        
        # Build the model based on the latest feature
        base_model &lt;- build_gam(c(cur_vars[1:i],cont_to_spline(rec_features, dt=base_training)),dt = base_training)
        base_model$rec_features &lt;- rec_features
        base_model$RecFeatureData &lt;- fam_survivalhood
  
        p_survival &lt;- predict(base_model, complete_dataset, type=&quot;response&quot;)
     
        # If the model has converged in terms of deviance, stop, otherwise continue iterating
        improvement &lt;- ((p_survival - last_p)^ 2 %&gt;% mean) * 10^4
        cat(&quot;\tIteration &quot; %|% it %|% &quot;: &quot; %|% improvement %|% &quot;\n&quot;)
        if (abs(improvement) &lt;= 1) {
          cat(&quot;\tAlgorithm has converged!\n&quot;)
          break
        } else {
          last_p &lt;- p_survival
        }
      }
    }, error= ..(e) %:=% { print(e) })
    
    # 4. Return Model
    return(base_model)
  })
}

m.gam &lt;- cache(&quot;m_gam&quot;, list(), ..() %:=% { mod.gam(features) })

highest_idx &lt;- which(sapply(1:length(m.gam), ..(g) %:=% { !is.null(m.gam[[g]]) })) %&gt;% max
f_list &lt;- m.gam[[highest_idx]]$formula %&gt;% as.character %&gt;% {.[3] } %&gt;% strsplit(&quot; \\+ &quot;) %&gt;% unlist %&gt;% { gsub(&quot;,[A-Za-z()0-9&gt;=\\* -]*|s\\(&quot;,&quot;&quot;,.) } %&gt;% { .[!(. %in% c(&quot;PmaleF&quot;,&quot;PfemaleF&quot;))] }

cat(&quot;List of Features in Order of Selection: \n&quot;, paste0(f_list,collapse=&quot;, &quot;))</code></pre>
<pre><code>## List of Features in Order of Selection: 
##  Sex, Pclass, Title, SibSp, Parch, Age, CabinNo, FamSize, Fare, CabinDeck</code></pre>
<p>Listed above are features of the model, sorted by the order they were selected. For instance, <span class="hl">Sex</span> was chosen first, followed by <span class="hl">Pclass</span> and <span class="hl">Title</span>. This strengthens our hypothesis that both <span class="hl">Sex</span> and <span class="hl">Pclass</span> are strong signals for survivability.</p>
</section>
<section id="performance" class="level3">
<h3>Performance</h3>
<p>To ensure the model is accurate, we need to find the optimal values for these two hyper-parameters:</p>
<ul>
<li><span class="hl">Number of Features</span>: The number of features used in prediction, and</li>
<li><span class="hl">Threshold</span>: The boundary that determines if a passenger is tagged as a survivor. For instance if a passenger has a 45% probability of surviving, the model may tag him/her as alive if the threshold is 30%, but dead if the threshold is 50%.</li>
</ul>
<pre class="r"><code># Create Cross Validation Function
cv.mod.gam &lt;- function(formula, train, test) {
  # 1. Generate Modified GAM Models
  gams &lt;- mod.gam(train)
  
  # 2. Get the MSE&#39;s for each GAM Model at different thresholds
  output &lt;- list()
  cur_env &lt;- environment()
  thresholds &lt;- 1:19*0.05
  walk(thresholds, ..(t) %:=% {
    err_rates &lt;- sapply(gams, ..(i) %:=% {
      if (is.null(i)) { return(Inf) }
      { predict(i, test, type=&quot;class&quot;, threshold = t) != test$Survived } %&gt;%
      { length(which(.)) / length(.) }
    })
    names(err_rates) &lt;- t %|% &quot;,&quot; %|% 1:length(err_rates)
    assign(&quot;output&quot;,append(output, err_rates), envir = cur_env)
  })
  
  output
}

# Run Cross Validation With Different Folds
# 5-Fold Focuses more on Variance Error while 10-Fold Focuses more on Bias Error
res.cv &lt;- cache(&quot;res_cv&quot;, list(), ..() %:=% { 
            crossValidation(learner(&quot;cv.mod.gam&quot;), 
                            dataset(Survived ~ ., features),
                            cvSettings(s = 1))
          }) %&gt;% 
          # Reformat CV Results Into a Table
          { tmp_tbl &lt;- .@foldResults %&gt;% as.data.frame
            tmp_tbl[,&quot;Fold&quot;] &lt;- rownames(tmp_tbl)
            tmp_tbl } %&gt;%
          gather(&quot;Params&quot;,&quot;Err_Rate&quot;,-Fold) %&gt;%
          mutate(Err_Rate = Err_Rate %&gt;% unlist) %&gt;%
          group_by(Params) %&gt;%
          summarise(MER = mean(Err_Rate),
                    SE = sd(Err_Rate)/sqrt(n()))

res.cv[,&quot;Threshold&quot;] &lt;- map(res.cv$Params, ~strsplit(.,&quot;,&quot;)[[1]][1]) %&gt;% unlist %&gt;% as.numeric
res.cv[,&quot;N_Params&quot;] &lt;- map(res.cv$Params, ~strsplit(.,&quot;,&quot;)[[1]][2]) %&gt;% unlist %&gt;% as.numeric

opt.row &lt;- res.cv %&gt;% arrange(MER) %&gt;% { .[1,] }
opt.threshold &lt;- opt.row$Threshold 
opt.n &lt;- opt.row$N_Params
opt.gam &lt;- m.gam[[opt.n]]
opt.gam$threshold &lt;- opt.threshold

cv_plot &lt;- ggplot(res.cv %&gt;% filter(MER != Inf &amp; Threshold &gt;= 0.25 &amp; Threshold &lt;= 0.75), 
                  aes(x=N_Params, y=Threshold)) +
          theme_lk() +
          geom_tile(aes(alpha=ifelse(Threshold == opt.threshold &amp; N_Params == opt.n, 99,MER),
                        fill=ifelse(Threshold == opt.threshold &amp; N_Params == opt.n, &quot;Optimal&quot;,NA))) +
          geom_text(data=res.cv %&gt;% subset((Threshold == opt.threshold &amp; N_Params == opt.n)),
                    aes(label=&quot;Optimal&quot;),
                    alpha = 1.,
                    color = `@c`(bg),
                    family = `@f`) +
          scale_x_continuous(name = &quot;Number of Features (Surfaced + Hidden)&quot;, breaks = 1:4 * 2,
                             expand = c(0,0),
                             labels= (1:4 * 2) %|% &quot; + 2&quot;) +
          scale_y_continuous(name = &quot;Threshold&quot;, labels=scales::percent,
                             expand = c(0,0)) + 
          scale_alpha_continuous(name=&quot;CV Error Rate&quot;, range=c(0.05,1), 
                                 limits=c(NA,0.25), na.value=1,
                                 labels=scales::percent, 
                                 guide=guide_legend(override.aes=list(fill=`@c`(ltxt,0.8)))) +
          scale_fill_manual(values=`@c`(green), na.value=`@c`(txt,0.8),
                            guide=&quot;none&quot;)

cv_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Based on the CV error rate, the optimal model is one with 4 + 2 features and 55% threshold.</p>
<pre class="r"><code>save_predictions &lt;- function(m.gam, id=&quot;opt&quot;) {
  
  p_y &lt;- predict(m.gam, test_features, type=&quot;class&quot;, threshold=m.gam$threshold)
  predictions &lt;- cbind(test_set %&gt;% select(PassengerId), Survived=p_y)
  write.csv(predictions, 
            file=paste0(output_dir,id,&quot;_submission.csv&quot;),
            row.names = FALSE)
}

save_predictions(opt.gam)
  
cat(paste0(&quot;Null Classifier\tTest Error Rate: &quot;, scales::percent(1.-0.62679),&quot;\n&quot;,
    &quot;Optimal GAM\t\tTest Error Rate: &quot;, scales::percent(1.-0.79904),&quot;\n&quot;))</code></pre>
<pre><code>## Null Classifier  Test Error Rate: 37.3%
## Optimal GAM      Test Error Rate: 20.1%</code></pre>
<p>Using Kaggle’s test set, the model has significantly higher predictive power over the <a data-toggle="popover" title="Null Classifier" data-content="A null classifier tags any passenger as died.">null classifier</a>. In fact, it is ranked near the 15th percentile* of <a href="https://www.kaggle.com/c/titanic/leaderboard" target="_blank">Kaggle’s Leaderboard</a>!</p>
<p><span style="font-size: 0.8em">*at time of submission</span></p>
</section>
<section id="interpretation" class="level3">
<h3>Interpretation</h3>
<pre class="r"><code>threshold_plot &lt;- res.cv %&gt;% filter(N_Params == opt.n) %&gt;%
                  {
                    ggplot(., aes(x=Threshold, y=MER)) +
                    theme_lk() +
                    geom_point(aes(color=Threshold != opt.threshold,
                                   shape = Threshold != opt.threshold,
                                   size = Threshold != opt.threshold), 
                               show.legend=FALSE) +
                    scale_color_manual(values=c(`@c`(red),`@c`(ltxt,0.5))) +
                    scale_shape_manual(values=c(4,16)) +
                    scale_size_manual(values=c(5,3)) +
                    geom_smooth(color=`@c`(1), fill=`@c`(ltxt,0.2), method=&#39;loess&#39;) +
                    scale_x_continuous(labels=scales::percent) + 
                    scale_y_continuous(name=&quot;CV Error Rate&quot;, labels=scales::percent)
                  }

threshold_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The above chart shows how a 4+2-feature model performs as we adjust the threshold. Other than the fact that the most optimal threshold is 55%, we also see that the curve remains relatively flat from 25% to 75%. This suggests that the model is relatively <span class="hl">pure</span>. In other words, it is more likely to predict a high/low likelihood of surviving, rather than a toss up situation where a passenger has a 51%-49% survival-death rate.</p>
<pre class="r"><code>coeffs &lt;- predict(opt.gam, features, type = &quot;terms&quot;) %&gt;% as.data.frame %&gt;%
          mutate(ID = rownames(.)) %&gt;%
          gather(&quot;Feature&quot;,&quot;Val&quot;,-ID) %&gt;%
          mutate(Feature = gsub(&quot;:[A-Za-z()&gt;=0-9\\* ]*|\\)|s\\(&quot;,&quot;&quot;,Feature))

x_vals &lt;- features %&gt;% 
          inner_join(opt.gam$RecFeatureData, by=&quot;PassengerId&quot;) %&gt;%
          mutate(ID = rownames(features)) %&gt;%
          gather(&quot;Feature&quot;,&quot;X&quot;,-ID)

x_f_raw &lt;- coeffs %&gt;%
           inner_join(x_vals, by=c(&quot;ID&quot;,&quot;Feature&quot;))

x_f_tbl &lt;- x_f_raw %&gt;%
           select(Feature, X, Val) %&gt;%
           filter(X != -1) %&gt;%
           group_by(Feature, X, Val) %&gt;%
           summarise(CohortSize=n()) %&gt;%
           ungroup() %&gt;%
           arrange(Feature, X)

cont_tbl &lt;- x_f_tbl %&gt;%
            filter(grepl(&quot;[0-9\\.]+&quot;,X)) %&gt;%
            mutate(X = X %&gt;% as.numeric)

cont_plot &lt;- ggplot(cont_tbl, aes(x=X, y=Val)) +
              geom_smooth(aes(weight=CohortSize), color=`@c`(ltxt,0.5), 
                          linetype=&quot;dotted&quot;, method=&quot;loess&quot;) +
              geom_point(aes(size=CohortSize), color=`@c`(1), alpha=0.8) +
              theme_lk() +
              scale_size_continuous(name=&quot;Cohort Size&quot;) +
              scale_y_continuous(name=&quot;f(X)&quot;) +
              facet_wrap(~toupper(Feature), ncol=2, scales=&quot;free&quot;, strip.position = &quot;bottom&quot;)

cont_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The plots above show the function <span class="math inline">\(f_i\)</span> for each continuous feature. All 4 plots suggest a close to linear relationship for <span class="math inline">\(f_i\)</span>. This implies that linear models might perform relatively well too. It is also worth noting that having 1 or 2 siblings does not affect survivalhood significantly, but any more than that does.</p>
<pre class="r"><code>discr_tbl &lt;- x_f_tbl %&gt;%
              filter(!grepl(&quot;[0-9\\.]+&quot;,X)) %&gt;%
              arrange(Feature, desc(Val)) %&gt;%
              mutate(X = factor(X, levels=unique(X)))

discr_plot &lt;- ggplot(discr_tbl, aes(x=X, y=Val)) +
              theme_lk() +
              geom_col(fill=`@c`(1,0.5), color=`@c`(1)) +
              scale_y_continuous(name=&quot;f(X)&quot;, expand=c(0,0,0.01,0)) +
              facet_wrap(~toupper(Feature), ncol=2, scales=&quot;free_x&quot;, strip.position = &quot;bottom&quot;)

discr_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Similarly, the plots above show the equivalent for discrete features. As before, we can deduce that females and passengers with distinguished titles are more likely to survive.</p>
<pre class="r"><code>imp_tbl &lt;- x_f_raw %&gt;%
           group_by(Feature) %&gt;%
           #Normalize all features so that the weighted sum of f(feature) = 0
           mutate(Val = abs(Val - sum(Val)/n())) %&gt;%
           ungroup() %&gt;% group_by(ID) %&gt;%
           mutate(PctImpt = Val / sum(Val)) %&gt;%
           group_by(Feature) %&gt;%
           summarise(PctImpt = mean(PctImpt)) %&gt;%
           arrange(PctImpt) %&gt;%
           mutate(Feature = factor(Feature, levels=Feature))

imp_plot &lt;- ggplot(imp_tbl, aes(fill=Feature, x=1, y=PctImpt)) + 
            theme_void() +
            theme_lk(fmt_x = FALSE, fmt_y = FALSE) +
            geom_col(position = position_stack(vjust = .5), 
                     width=0.7, show.legend = FALSE) +
            geom_text(aes(label=Feature,x=0.4),
                          size=3.5,
                          position = position_stack(vjust = .5),
                          family = `@f`,
                          color = `@c`(txt), 
                          angle = 90,
                          hjust = 1.) +
            geom_text(aes(label=scales::percent(round(..y..,2))),
                            position = position_stack(vjust = .5),
                            family = `@f`,
                            color = `@c`(bg)) +
            scale_fill_manual(values=`@c`(palette)(6) %&gt;% rev) +
            lims(x = c(-0.5,NA)) +
            coord_flip()

imp_plot</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The chart above shows the strength of each feature relative to one another. As can be seen, both <span class="hl yellow-text">Sex</span> and <span class="hl orange-text">Pclass</span> contribute over 60% to the prediction! This confirms our hypothesis that both <span class="hl yellow-text">Sex</span> and <span class="hl orange-text">Pclass</span> are important factors of survivability.</p>
</section>
</section>
<section id="summary-of-results" class="level2">
<h2>Summary of Results</h2>
<p>Using data from the demographics and outcomes of titanic passengers, we have created a prediction model that performs near the 15th percentile of <a href="https://www.kaggle.com/c/titanic/leaderboard" target="_blank">Kaggle’s Leaderboard</a>. In addition, we have also identified the factors that determine each passenger’s survival status. These factors, ranked by importance, are:</p>
<ol type="1">
<li><span class="hl yellow-text">Sex</span>: Females are more likely to survive than males.</li>
<li><span class="hl orange-text">Passenger Class</span>: Premium passengers accrue additional benefits, including preferential access to the lifeboats.</li>
<li><span class="hl red-text">Title</span>: Someone with an esteemed title have more privileges than a lay individual.</li>
<li><span class="hl blue-text">Survivalhood of Family Members</span>: A passenger’s survival likelihood is influenced by those with him/her.</li>
<li><span class="hl cyan-text">No. of Siblings</span>: The higher the number of siblings, the more likely one will die.</li>
</ol>
</section>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
